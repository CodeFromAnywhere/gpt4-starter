import * as fetch from 'node-fetch'
import * as fs from 'fs'

import { Data } from './Data'

export async function request(data: Data) {
	const url = `https://api-inference.huggingface.co/models/${data.model}`
	const text = data.text || String(fs.readFileSync(data.file))
	const key = data.api_key

	const returned = await fetch.default(url, {
		method: 'POST',
		body: text,
		headers: { 'Authorization': `Bearer ${key}` }
	}).catch((err) => {
		throw err // Error caused by node-fetch
	})

	const obj = await returned.json()

	if (data.return_type === 'FULL') {
		return obj
	} else if (data.return_type === 'OBJ') {
		return obj[0]
	} else if (data.return_type === 'STRING') {
		return obj[0].generated_text
	} else {
		throw new Error('return_type has to be "FULL" or "OBJ" or "STRING"')
	}
}