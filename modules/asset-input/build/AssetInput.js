"use strict";var __assign=this&&this.__assign||function(){return __assign=Object.assign||function(e){for(var n,t=1,i=arguments.length;t<i;t++)for(var r in n=arguments[t])Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r]);return e},__assign.apply(this,arguments)},__awaiter=this&&this.__awaiter||function(e,n,t,i){return new(t||(t=Promise))((function(r,a){function o(e){try{s(i.next(e))}catch(e){a(e)}}function l(e){try{s(i.throw(e))}catch(e){a(e)}}function s(e){var n;e.done?r(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(o,l)}s((i=i.apply(e,n||[])).next())}))},__generator=this&&this.__generator||function(e,n){var t,i,r,a,o={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return a={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function l(l){return function(s){return function(l){if(t)throw new TypeError("Generator is already executing.");for(;a&&(a=0,l[0]&&(o=0)),o;)try{if(t=1,i&&(r=2&l[0]?i.return:l[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,l[1])).done)return r;switch(i=0,r&&(l=[2&l[0],r.value]),l[0]){case 0:case 1:r=l;break;case 4:return o.label++,{value:l[1],done:!1};case 5:o.label++,i=l[1],l=[0];continue;case 7:l=o.ops.pop(),o.trys.pop();continue;default:if(!(r=o.trys,(r=r.length>0&&r[r.length-1])||6!==l[0]&&2!==l[0])){o=0;continue}if(3===l[0]&&(!r||l[1]>r[0]&&l[1]<r[3])){o.label=l[1];break}if(6===l[0]&&o.label<r[1]){o.label=r[1],r=l;break}if(r&&o.label<r[2]){o.label=r[2],o.ops.push(l);break}r[2]&&o.ops.pop(),o.trys.pop();continue}l=n.call(e,o)}catch(e){l=[6,e],i=0}finally{t=r=0}if(5&l[0])throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}([l,s])}}},__spreadArray=this&&this.__spreadArray||function(e,n,t){if(t||2===arguments.length)for(var i,r=0,a=n.length;r<a;r++)!i&&r in n||(i||(i=Array.prototype.slice.call(n,0,r)),i[r]=n[r]);return e.concat(i||Array.prototype.slice.call(n))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AssetInput=void 0;var jsx_runtime_1=require("react/jsx-runtime"),react_with_native_store_1=require("react-with-native-store"),react_1=require("react"),react_with_native_1=require("react-with-native"),clickable_icon_1=require("clickable-icon"),api_1=require("api"),server_api_url_1=require("server-api-url"),js_util_1=require("js-util"),asset_view_1=require("asset-view"),react_with_native_alert_1=require("react-with-native-alert"),asset_functions_js_1=require("asset-functions-js"),MediaRecorder_1=require("./MediaRecorder"),Webcam_1=require("./Webcam"),SelectMedia_1=require("./select-media/SelectMedia"),FileInput_1=require("./FileInput"),makeBackendAsset_1=require("./util/makeBackendAsset"),model_types_1=require("model-types"),AssetInput=function(e){var n=e.immediateUpload,t=e.attachTokenToFilename,i=e.defaultAssetName,r=e.onChange,a=(e.allowMultiple,e.value),o=e.inputTypes,l=e.projectRelativeReferencingFilePath,s=e.modelName,c=e.onChangeLoading,u=(0,react_1.useState)((0,model_types_1.generateRandomString)(32))[0],_=(0,asset_functions_js_1.ensureToken)(i,u,t),d=(0,react_with_native_alert_1.useAlert)(),p=o&&1===o.length?o[0]:null,m=(0,react_1.useState)(p),f=m[0],v=m[1],b=(0,react_1.useState)([]),h=b[0],j=b[1],x=(0,react_1.useState)(a||[]),g=x[0],k=x[1],y=(0,react_1.useState)(_),w=y[0],S=y[1];
/**
     * generate a random token for this component, once, only if it loads...
     */(0,react_1.useEffect)((function(){var e=g.map((function(e){return e.name===w?__assign(__assign({},e),{name:_}):e}));k(e),S(_)}),[_]);
/**
     * Removes asset from selectedBlobs, external value, and at the server
     */
var A=function(e,n){return __awaiter(void 0,void 0,void 0,(function(){var t,i,o,s;return __generator(this,(function(c){switch(c.label){case 0:return t=(0,js_util_1.removeIndexFromArray)(g,n),k(t),i=(0,js_util_1.removeIndexFromArray)(a||[],n),r(i),e.relativePath?[4/*yield*/,api_1.api.deleteReferencedAsset(l,e.relativePath)]:[3/*break*/,2];case 1:o=c.sent().result,s=null==o?void 0:o.isSuccessful,null==d||d(s?"Deleted":"Something went wrong",null==o?void 0:o.message),c.label=2;case 2:return[2/*return*/]}}))}))},C=function(e,n){return __awaiter(void 0,void 0,void 0,(function(){var t,i,r,a,o;return __generator(this,(function(l){switch(l.label){case 0:return e.blob&&e.blobPath?[4/*yield*/,(0,react_with_native_store_1.getItem)(api_1.AUTH_TOKEN_STORAGE_KEY)]:(console.log("Please provide a blob and blobPath to send the blob"),[2/*return*/]);case 1:return t=l.sent(),i=(null==n?void 0:n.authToken)||t,r=(null==n?void 0:n.apiUrl)||server_api_url_1.apiUrl,a="".concat(r,"/function/uploadAssetWithContext"),o=new XMLHttpRequest,[4/*yield*/,new Promise((function(n,t){o.upload.addEventListener("abort",(function(){console.log("XHR Upload Abort"),t({isSuccessful:!1})})),o.upload.addEventListener("error",(function(){console.log("XHR Upload Error"),t({isSuccessful:!1})})),o.upload.addEventListener("timeout",(function(){console.log("XHR Upload Timeout"),t({isSuccessful:!1})})),o.upload.addEventListener("progress",(function(n){if(n.lengthComputable){var t=n.loaded/n.total;
// console.log("upload progress:", uploadProgress);
i=e.blobPath,r=__assign(__assign({},e),{uploadProgress:t}),k((function(e){return e.map((function(e){return e.blobPath===i?r:e}))}))}var i,r})),o.addEventListener("progress",(function(e){if(e.lengthComputable)e.loaded,e.total;
// console.log("download progress:", downloadProgress);
// TODO: set this to a state
})),o.addEventListener("loadend",(function(e){var t=4===o.readyState&&200===o.status,i=o.response?JSON.parse(o.response):void 0;n({isSuccessful:t,response:i})})),o.addEventListener("timeout",(function(e){console.log("XHR Timeout"),t({isSuccessful:!1})})),o.addEventListener("error",(function(e){console.log("XHR Error"),t({isSuccessful:!1})})),o.addEventListener("abort",(function(e){console.log("XHR Aborted"),t({isSuccessful:!1})})),o.open("POST",a,!0);var r=new FormData;r.append("file",e.blob),i&&
// NB: we need to adhere the `api` convention!
r.append("authToken",i),o.send(r)}))];case 2:
// NB: now, call onchange
// console.log("success:", xhrResult);
return[2/*return*/,l.sent().response]}}))}))},P=function(e){return __awaiter(void 0,void 0,void 0,(function(){var n,t,i,o;return __generator(this,(function(u){switch(u.label){case 0:return 0===(n=e||h).length?(console.log("no new blobs length"),[2/*return*/]):(null==c||c(!0),k(__spreadArray(__spreadArray([],g,!0),n,!0)),j([]),[4/*yield*/,Promise.all(n.map((function(e){return __awaiter(void 0,void 0,void 0,(function(){var n,t,i,r;return __generator(this,(function(a){switch(a.label){case 0:return[4/*yield*/,C(e)];case 1:return(n=a.sent())?(t=__assign(__assign({},e),{temporaryDestination:null===(r=n.result)||void 0===r?void 0:r.temporaryDestination}),i=(0,makeBackendAsset_1.makeBackendAsset)(t,l,s),[2/*return*/,{newSelectedBlob:t,newBackendAsset:i}]):[2/*return*/]}}))}))})))]);case 1:return t=u.sent().filter(js_util_1.notEmpty),i=t.map((function(e){return e.newBackendAsset})),o=t.map((function(e){return e.newSelectedBlob})),k(o),null==c||c(!1),r(a?__spreadArray(__spreadArray([],a,!0),i,!0):i),[2/*return*/]}}))}))};
/**
     * Local update!
     */return(0,jsx_runtime_1.jsxs)(react_with_native_1.Div,__assign({className:n?"":"w-96"},{children:[null===f||p?(0,jsx_runtime_1.jsxs)(react_with_native_1.Div,__assign({className:n?"hidden":void 0},{children:[null===f?(0,jsx_runtime_1.jsxs)(react_with_native_1.Div,__assign({className:"flex flex-row"},{children:[!o||o.includes("recordAudio")?(0,jsx_runtime_1.jsx)(clickable_icon_1.ClickableIcon,{emoji:"🔈",onClick:function(){return v("recordAudio")}}):null,!o||o.includes("recordVideo")?(0,jsx_runtime_1.jsx)(clickable_icon_1.ClickableIcon,{emoji:"🎥",onClick:function(){return v("recordVideo")}}):null,!o||o.includes("recordScreen")?(0,jsx_runtime_1.jsx)(clickable_icon_1.ClickableIcon,{emoji:"💻",onClick:function(){return v("recordScreen")}}):null,!o||o.includes("camera")?(0,jsx_runtime_1.jsx)(clickable_icon_1.ClickableIcon,{emoji:"📸",onClick:function(){return v("camera")}}):null,!o||o.includes("files")?(0,jsx_runtime_1.jsx)(clickable_icon_1.ClickableIcon,{emoji:"📂",onClick:function(){return v("files")}}):null,!o||o.includes("project-media")?(0,jsx_runtime_1.jsx)(clickable_icon_1.ClickableIcon,{emoji:"👑",onClick:function(){return v("project-media")}}):null,!o||o.includes("p2p-media")?(0,jsx_runtime_1.jsx)(clickable_icon_1.ClickableIcon,{emoji:"👥",onClick:function(){return v("p2p-media")}}):null,!o||o.includes("youtube")?(0,jsx_runtime_1.jsx)(clickable_icon_1.ClickableIcon,{emoji:"⏯",onClick:function(){return v("youtube")}}):null,!o||o.includes("google-images")?(0,jsx_runtime_1.jsx)(clickable_icon_1.ClickableIcon,{emoji:"🔎",onClick:function(){return v("google-images")}}):null,!o||o.includes("giphy")?(0,jsx_runtime_1.jsx)(clickable_icon_1.ClickableIcon,{emoji:"🦄",onClick:function(){return v("giphy")}}):null,!o||o.includes("unsplashed")?(0,jsx_runtime_1.jsx)(clickable_icon_1.ClickableIcon,{emoji:"🌅",onClick:function(){return v("unsplashed")}}):null]})):null,null==g?void 0:g.map((function(e,n){return(0,jsx_runtime_1.jsx)(asset_view_1.InteractiveAsset,{attachTokenToFilename:t,projectRelativeReferencingFilePath:l,asset:e,remove:function(){return __awaiter(void 0,void 0,void 0,(function(){return __generator(this,(function(t){return[2/*return*/,A(e,n)]}))}))},onChange:function(t){var i=g.map((function(i,r){return r===n?t:e}));k(i);var o=a?a.map((function(e){var n=e.relativePath||e.temporaryDestination,i=t.relativePath||t.temporaryDestination;return void 0!==n&&void 0!==i&&n===i?(0,makeBackendAsset_1.makeBackendAsset)(t,l,s):e})):void 0;o&&r(o)}},"asset".concat(n))}))]})):null,null!==f||p?(0,jsx_runtime_1.jsxs)(react_with_native_1.Div,__assign({className:"flex flex-row justify-between"},{children:[p?(0,jsx_runtime_1.jsx)(react_with_native_1.Div,{}):(0,jsx_runtime_1.jsx)(clickable_icon_1.ClickableIcon,{emoji:"❌",onClick:function(){j([]),p||v(null)}}),h.length>0?(0,jsx_runtime_1.jsx)(clickable_icon_1.ClickableIcon,{emoji:"✅",onClick:function(){P(),j([]),p||v(null)}}):(0,jsx_runtime_1.jsx)(react_with_native_1.Div,{})]})):null,(0,jsx_runtime_1.jsxs)(react_with_native_1.Div,{children:["files"===f?(0,jsx_runtime_1.jsx)(FileInput_1.FileInput,{setBlobs:function(e){
// when this thing is hidden, add them to upload immediately
n?P(e):j(e)}}):null,"camera"===f?(0,jsx_runtime_1.jsx)(Webcam_1.WebcamCapture,{withBlob:function(e,n){return j([{blobPath:e,type:"image",blob:n,name:_,sizeBytes:n.size,uploadProgress:0}])}}):null,"recordAudio"===f?(0,jsx_runtime_1.jsx)(MediaRecorder_1.MediaRecorder,{type:"audio",withBlob:function(e,n){return j([{blobPath:e,type:"audio",blob:n,name:_,uploadProgress:0,sizeBytes:n.size}])}}):null,"recordVideo"===f?(0,jsx_runtime_1.jsx)(MediaRecorder_1.MediaRecorder,{type:"video",withBlob:function(e,n){return j([{blobPath:e,type:"video",blob:n,name:_,sizeBytes:n.size,uploadProgress:0}])}}):null,"recordScreen"===f?(0,jsx_runtime_1.jsx)(MediaRecorder_1.MediaRecorder,{type:"screen",withBlob:function(e,n){return j([{blobPath:e,type:"video",blob:n,name:_,sizeBytes:n.size,uploadProgress:0}])}}):null,"project-media"===f?(0,jsx_runtime_1.jsx)(SelectMedia_1.SelectMedia,{source:"project"}):null,"p2p-media"===f?(0,jsx_runtime_1.jsx)(SelectMedia_1.SelectMedia,{source:"p2p"}):null,"google-images"===f?(0,jsx_runtime_1.jsx)(SelectMedia_1.SelectMedia,{source:"google"}):null,"giphy"===f?(0,jsx_runtime_1.jsx)(SelectMedia_1.SelectMedia,{source:"giphy"}):null,"unsplashed"===f?(0,jsx_runtime_1.jsx)(SelectMedia_1.SelectMedia,{source:"unsplashed"}):null,"youtube"===f?(0,jsx_runtime_1.jsx)(SelectMedia_1.SelectMedia,{source:"youtube"}):null]})]}))};exports.AssetInput=AssetInput;
//# sourceMappingURL=AssetInput.js.map