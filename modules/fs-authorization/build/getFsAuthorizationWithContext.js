"use strict";var __awaiter=this&&this.__awaiter||function(t,e,r,i){return new(r||(r=Promise))((function(n,a){function o(t){try{u(i.next(t))}catch(t){a(t)}}function l(t){try{u(i.throw(t))}catch(t){a(t)}}function u(t){var e;t.done?n(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(o,l)}u((i=i.apply(t,e||[])).next())}))},__generator=this&&this.__generator||function(t,e){var r,i,n,a,o={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return a={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function l(l){return function(u){return function(l){if(r)throw new TypeError("Generator is already executing.");for(;a&&(a=0,l[0]&&(o=0)),o;)try{if(r=1,i&&(n=2&l[0]?i.return:l[0]?i.throw||((n=i.return)&&n.call(i),0):i.next)&&!(n=n.call(i,l[1])).done)return n;switch(i=0,n&&(l=[2&l[0],n.value]),l[0]){case 0:case 1:n=l;break;case 4:return o.label++,{value:l[1],done:!1};case 5:o.label++,i=l[1],l=[0];continue;case 7:l=o.ops.pop(),o.trys.pop();continue;default:if(!(n=o.trys,(n=n.length>0&&n[n.length-1])||6!==l[0]&&2!==l[0])){o=0;continue}if(3===l[0]&&(!n||l[1]>n[0]&&l[1]<n[3])){o.label=l[1];break}if(6===l[0]&&o.label<n[1]){o.label=n[1],n=l;break}if(n&&o.label<n[2]){o.label=n[2],o.ops.push(l);break}n[2]&&o.ops.pop(),o.trys.pop();continue}l=e.call(t,o)}catch(t){l=[6,t],i=0}finally{r=n=0}if(5&l[0])throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}([l,u])}}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getFsAuthorizationWithContext=void 0;var fs_util_1=require("fs-util"),fs_util_js_1=require("fs-util-js"),get_path_1=require("get-path"),js_util_1=require("js-util"),search_fs_1=require("search-fs"),getFsAuthorizationSingleFile_1=require("./getFsAuthorizationSingleFile"),getFsAuthorizationWithContext=function(t,e,r){return __awaiter(void 0,void 0,void 0,(function(){var i,n,a,o,l,u,s,c,h,_,f,p,d,v,g,j,F;return __generator(this,(function(b){switch(b.label){case 0:return i=(null===(j=t.device.currentPersonCalculated)||void 0===j?void 0:j.groupSlugs)||["public"],n=1===i.length&&"public"===i[0],a=t?(0,search_fs_1.getExplorableBasePathsWithContext)(t):[],o=(null===(F=a.find((function(t){
// NB: the "/" is super important to ensure it's the end of the folder
return e===t.projectRelativePath||e.startsWith(t.projectRelativePath+"/")})))||void 0===F?void 0:F.projectRelativePath)||"",l=n?{canRead:!0,canWrite:!1}:""!==o?{canRead:!0,canWrite:!0}:{canRead:!1,canWrite:!1},(u=(0,get_path_1.getProjectRoot)())?(s=fs_util_1.path.join(u,e),fs_util_1.fs.existsSync(s)?[4/*yield*/,fs_util_1.fs.stat(s)]:[3/*break*/,2]):[2/*return*/,{canRead:!1,canWrite:!1}];case 1:return h=b.sent().isDirectory(),[3/*break*/,3];case 2:h=void 0,b.label=3;case 3:return _=(c=h)?e:(0,fs_util_js_1.makeRelative)(fs_util_1.path.parse(s).dir,u),f=(0,fs_util_js_1.makeRelative)(_,o),p=(0,fs_util_1.getAllFoldersUntilFolder)(f).map((function(t){return fs_util_1.path.join(o,t)})),r&&console.log({projectRelativePath:e,projectRelativeFolderPath:_,projectRelativeBaseFolderPath:o,user_groupSlugs:i,basePathRelativeFolderPath:f,projectRelativeFolderPaths:p}),[4/*yield*/,Promise.all(p.map((function(t){return(0,fs_util_1.returnReadmePathFromFolder)(fs_util_1.path.join(u,t))})))];case 4:return d=b.sent().filter(js_util_1.notEmpty).map((function(t){return(0,fs_util_js_1.makeRelative)(t,u)})),v=c?d:d.concat(e).filter((0,js_util_1.onlyUnique2)()),[4/*yield*/,Promise.all(v.map((function(t){return __awaiter(void 0,void 0,void 0,(function(){var e;return __generator(this,(function(r){switch(r.label){case 0:return[4/*yield*/,(0,getFsAuthorizationSingleFile_1.getFsAuthorizationSingleFile)({projectRelativeFilePath:t,user_groupSlugs:i})];case 1:return e=r.sent(),[2/*return*/,{projectRelativeFilePath:t,authorization:e}]}}))}))})))];case 5:return g=b.sent(),r&&console.dir({allProjectRelativeFilePaths:v,baseAuthorization:l,allFolderAuthorizations:g},{depth:999}),[2/*return*/,g.reduce((function(t,e){
// If we found an authorization for this file, return it. Otherwise return the previous one
return e.authorization||t}),l)]}}))}))};exports.getFsAuthorizationWithContext=getFsAuthorizationWithContext;
//# sourceMappingURL=getFsAuthorizationWithContext.js.map