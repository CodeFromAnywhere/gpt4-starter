"use strict";var __awaiter=this&&this.__awaiter||function(e,t,o,r){return new(o||(o=Promise))((function(s,n){function a(e){try{l(r.next(e))}catch(e){n(e)}}function i(e){try{l(r.throw(e))}catch(e){n(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,i)}l((r=r.apply(e,t||[])).next())}))},__generator=this&&this.__generator||function(e,t){var o,r,s,n,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return n={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(n[Symbol.iterator]=function(){return this}),n;function i(i){return function(l){return function(i){if(o)throw new TypeError("Generator is already executing.");for(;n&&(n=0,i[0]&&(a=0)),a;)try{if(o=1,r&&(s=2&i[0]?r.return:i[0]?r.throw||((s=r.return)&&s.call(r),0):r.next)&&!(s=s.call(r,i[1])).done)return s;switch(r=0,s&&(i=[2&i[0],s.value]),i[0]){case 0:case 1:s=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(s=a.trys,(s=s.length>0&&s[s.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!s||i[1]>s[0]&&i[1]<s[3])){a.label=i[1];break}if(6===i[0]&&a.label<s[1]){a.label=s[1],s=i;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(i);break}s[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],r=0}finally{o=s=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,l])}}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.processAsset=void 0;var fs_util_1=require("fs-util"),get_path_1=require("get-path"),convert_case_1=require("convert-case"),getStorageLocationInfo_1=require("./getStorageLocationInfo"),getTemporaryAssetsFolderPath_1=require("./getTemporaryAssetsFolderPath"),log_1=require("log"),js_util_1=require("js-util"),processAsset=function(
/**
 * The backendAsset that may need processing
 */
e,t){return __awaiter(void 0,void 0,void 0,(function(){var o,r,s,n,a,i,l,c,u,p,_,f,g,h,d,v,y,b;return __generator(this,(function(A){switch(A.label){case 0:return(o=(0,get_path_1.getProjectRoot)())?(r=e?(0,js_util_1.takeFirst)(e):void 0)?(s=r.alt,n=r.name,a=r.relativePath,i=r.temporaryDestination,l=r.projectRelativeReferencingFilePath,c=r.modelName,l?(u=fs_util_1.path.join(o,l),p=(0,convert_case_1.slugify)(n&&n.length>0?n:"untitled"),a||i?
// NB: If a `temporaryDestination` is given, if it doesn't exist, we return nothing, this is an invalid input.
(_=i?fs_util_1.path.join((0,getTemporaryAssetsFolderPath_1.getTemporaryAssetsFolderPath)(),i):void 0)&&!fs_util_1.fs.existsSync(_)?((0,log_1.log)("processAsset: absoluteTemporaryDestination does not exist",{type:"warning"}),[2/*return*/,void 0]):
// NB: if a relativePath is provided without a temporaryDestination, it means the file should already be there. If it's not there, we return nothing, invalid input.
!(f=a?fs_util_1.path.join(fs_util_1.path.parse(u).dir,a):void 0)||i||fs_util_1.fs.existsSync(f)?(g=i?i.split(".").pop():null==a?void 0:a.split(".").pop())?(h=(0,getStorageLocationInfo_1.getStorageLocationInfo)(u,c),d=(null==t?void 0:t.customAbsoluteFolderPath)||h.absoluteAssetBaseFolderPath,v=fs_util_1.path.join(d,"".concat(p,".").concat(g)),y=v,_?(y=(0,fs_util_1.getFirstAvailableFilename)(v),[4/*yield*/,(0,fs_util_1.renameAndCreate)(_,y)]):[3/*break*/,2]):((0,log_1.log)("processAsset: could not create extension",{type:"warning"}),[2/*return*/,void 0]):((0,log_1.log)("processAsset: oldAssetStoragePath does not exist (".concat(f,")"),{type:"warning"}),[2/*return*/,void 0]):((0,log_1.log)("processAsset: no relativePath, no temporaryDestination",{type:"warning"}),[2/*return*/,void 0])):((0,log_1.log)("processAsset: projectRelativeReferencingFilePath wasn't provided, not processing asset",{type:"warning"}),[2/*return*/,void 0])):(console.log("processAsset: No real backend asset"),[2/*return*/]):(console.log("processAsset: No project root"),[2/*return*/]);case 1:return A.sent(),[3/*break*/,4];case 2:return f?f===v?[3/*break*/,4]:(y=(0,fs_util_1.getFirstAvailableFilename)(v),[4/*yield*/,(0,fs_util_1.renameAndCreate)(f,y)]):[3/*break*/,4];case 3:
// the name has changed
A.sent(),A.label=4;case 4:return b=(0,get_path_1.getRelativeLinkPath)(u,y),
//({ newRelativePath });
console.log({alt:s,relativePath:a}),[2/*return*/,{alt:s,relativePath:b}]}}))}))};exports.processAsset=processAsset;
//# sourceMappingURL=processAsset.js.map